<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nashville Airbnb Occupancy Map</title>

  <!--Bootstrap CSS-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

  <!--Personal CSS-->
  <link rel="stylesheet" href="styles.css">

  <!--Leaflet CSS-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin="" />
</head>

<body>
  <div class="container-fluid">
    <header class="row bg-dark text-white py-3">
      <div class="col">
        <h1>For Rent or Vacation? Measuring the Short-Term Rental Market Against Housing Occupancy in Nashville,
          Tennessee </h1>
      </div>
    </header>

    <section class="row">
      <div class="col-md-8 col-lg-9 col-xl-10 order-md-2 px-0">
        <div id="map"></div>
      </div>
      <aside id="about" class="col-md-4 col-lg-3 col-xl-2 order-md-1 text-white py-2 pl-3 bg-secondary overflow-auto">
        <section>
          <h3 class="py-2">Housing Occupancy and the Short Term Rental Market</h3>
          <p>A fan brush is a fantastic piece of equipment. Use it. Make friends with it. We're not trying to teach you
            a thing to copy. We're just here to teach you a technique, then let you loose into the world. We'll put a
            happy little sky in here.</p>
          <p>You are only limited by your imagination. We'll do another happy little painting. Work on one thing at a
            time. Don't get carried away - we have plenty of time. Look at them little rascals. We'll put all the little
            clouds in and let them dance around and have fun. You can spend all day playing with mountains.</p>
        </section>
      </aside>
    </section>

    <footer class="row bg-dark text-white py-3">
      <div class="col">
        <ul class="list-unstyled">
          <li>authored by <a href="https://realcaddish.github.io/">Nathaniel Deaton</a></li>
          <li>Map Authored in May, 2022</li>
          <li>data source: <a href="#">data source</a></li>
        </ul>
      </div>
    </footer>
  </div>

  <!-- legend is outside of container-fluid and will be dynamically added to map -->
  <div class="bg-secondary py-2 px-3 ml-3 mt-3 text-white" id="legend"></div>

  <!-- ui is outside of container-fluid and will be dynamically added to map -->
  <div class="form-group mr-3 mt-3" id="dropdown-ui">
    <label>Choose a data attribute to learn more</label>
    <select class="form-control bg-secondary text-white">
      <option value="airbnbs" selected>airbnbs by block group</option>
      <option value="occ_percent">percent of units occupied</option>
      <option value="vaca_percent">percent of units vacant</option>
    </select>
  </div>

  <!--Bootstrap CDN-->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
  </script>
  <!--Leaflet CDN -->
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>
  <!--D3 library-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.4.4/d3.min.js"></script>
  <!--topojson-->
  <script src="https://unpkg.com/topojson@3"></script>
  <!--jquery CDN -->
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <!--simple statistics CDN-->
  <script src='https://unpkg.com/simple-statistics@7.7.5/dist/simple-statistics.min.js'></script>
  <!--Turf.js CDN-->
  <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
</body>
<script>
  // set options for the map object
  const options = {
    zoomSnap: .1,
    center: [36.1627, -86.7816],
    zoom: 11,
    minZoom: 2,
    maxZoom: 13,
  };

  // creating the map object
  const map = L.map('map', options);

  // load in data with d3 fetch
  const blocksDataRaw = d3.json('/data/geojson/blocks_census_airbnb_joined.geojson');
  const listingsDataRaw = d3.csv('/data/csv/listings_cleaned.csv')
  const listingsGeojson = d3.json('./data/geojson/listings_cleaned.geojson')

  // promise statement to call an array of data variables then proceed to mapping function
  Promise.all([blocksDataRaw, listingsGeojson]).then(drawMap);

  // set global variables for map layer
  // mapped attribute, and normalizing attribute 
  let attributeValue = 'total_occu_sum'
  let normValue = "total_unit_sum"

  console.log(normValue)

  function drawMap(data) {

    // display Carto basemap tiles with light features and labels
    const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    // add basemap tiles to map
    tiles.addTo(map);

    const blocks = data[0];
    const listings = data[1]

    console.log(blocks)
    console.log(listings)

    // create Leaflet data layer and add to map
    const blockGroups = L.geoJson(data[0], {
      // style counties with initial default path options
      style: function (feature) {
        return {
          color: '#20282e',
          weight: 2,
          fillOpacity: .7,
          fillColor: '#1f78b4'
        };
      },
      // add hover/touch functionality to each feature layer
      onEachFeature: function (feature, layer) {

        // when mousing over a layer
        layer.on('mouseover', function () {

          // change the stroke color and bring that element to the front
          layer.setStyle({
            color: '#ff6e00'
          }).bringToFront();
        });

        // on mousing off layer
        layer.on('mouseout', function () {

          // reset the layer style to its original stroke color
          layer.setStyle({
            color: '#20282e'
          });
        });

        // zoom to block group on click
        layer.on('click', function (e) {
          map.setView(e.latlng, 13)
        })
      }
    }).addTo(map);

    // airbnb point circle options
    var geojsonMarkerOptions = {
      radius: 8,
      fillColor: "#ff7800",
      color: "#000",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    };

    // fit the map's bounds and zoom level using the counties extent
    map.fitBounds(blockGroups.getBounds(), {
      padding: [18, 18] // add padding around counties
    });


    // add airbnb points to map
    var airbnbListings = L.geoJson(data[1], {
      style: function (feature) {
        return {
          color: feature.properties.host_name
        }
      },
      pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, geojsonMarkerOptions)
      }
    });
    
    // convert airbnbs to turf-friendly geojson 
    var turfAirbnbs = airbnbListings.toGeoJSON();

    // loop through blockGroups and update with points within the polygon from Turf 
    blockGroups.eachLayer(function (layer) {
      // convert Leaflet layer to geojson with Leaflet toGeoJSON() method
      var turfBlocks = layer.toGeoJSON();

      // if the result's feature is inside the polygon
      if (turf.booleanPointInPolygon(turfAirbnbs, turfBlocks)) {
        // adjust the map pan/zoom to the block group bounds
        map.flyToBounds(layer.getBounds(), {
          padding: [20, 20]
        });

        // when the map is zooming on the flyto 
        map.on("zoomend", function () {
          layer.setStyle({
              color: '#f0dc00',
              fill: false,
              weight: '3'
            })
            .bringToFront();
        })
      }
    })

    // function calls to loop through
    updateMap(blockGroups);
    addUi(blockGroups);
  }
  ///////////////////////////////////////////////////////////////
  // get class breaks for data based on airbnbs per block 
  function getClassBreaks(blockGroups) {

    // create empty array for storing values 
    const values = [];

    // loop through all of the blocks 
    blockGroups.eachLayer(function (layer) {
      let value = layer.feature.properties[attributeValue] / layer.feature.properties[normValue];
      values.push(value);
    });

    // determine similar clusters
    const clusters = ss.ckmeans(values, 5);

    // create an array of the lowest value within each cluster 
    const breaks = clusters.map(function (cluster) {
      return [cluster[0], cluster.pop()];
    });

    // return an array of arrays 
    return breaks;
  }
  ////////////////////////////////////////////
  // Get color of blockgroup
  function getColor(d, breaks) {
    // function accepts a single normalized data attribute value
    // and uses a series of conditional statements to determine which
    // which color value to return to return to the function caller

    if (d <= breaks[0][1]) {
      return '#edf8fb';
    } else if (d <= breaks[1][1]) {
      return '#b3cde3';
    } else if (d <= breaks[2][1]) {
      return '#8c96c6';
    } else if (d <= breaks[3][1]) {
      return '#8856a7'
    } else if (d <= breaks[4][1]) {
      return '#810f7c'
    }
  }
  /////////////////////////////////////////
  function updateMap(blockGroups) {

    // check if the data is being pipelined from drawMap function to updateMap function
    console.log(blockGroups)

    // get the class breaks for the current data attribute 
    const breaks = getClassBreaks(blockGroups);

    // loop through each block layer and update the color and tooltip info 
    blockGroups.eachLayer(function (layer) {

      const props = layer.feature.properties;

      // set the fill color of the layer based on its normalized data value 
      layer.setStyle({
        fillColor: getColor(props[attributeValue] / props[normValue], breaks)
      });

      // assemble string sequence of info for tooltip 

      let tooltipInfo = `<b>Tract: ${props.TRACTCE}</b></br>
      ${((props[attributeValue] / props[normValue]) * 100).toLocaleString()}%`

      // bind tooltip to layer with block-specific information
      layer.bindTooltip(tooltipInfo, {
        //sticky property so tooltip follows mouse
        sticky: true
      });
    });

    // update legend with current data attribut info 
    addLegend(breaks);
  }
  ////////////////////////////////////////////////////////////////////////
  // add legend to map 
  function addLegend(breaks) {

    // create new Leaflet control object and position it top left 
    const legendControl = L.control({
      position: 'bottomright'
    });

    // when legend is added to the map 
    legendControl.onAdd = function () {

      // select a div element with an id attribute of legend
      const legend = L.DomUtil.get('legend');

      // disable scroll and click/touch on map when on legend
      L.DomEvent.disableScrollPropagation(legend);
      L.DomEvent.disableClickPropagation(legend);

      // return the selection to the method 
      return legend;

    };

    // add the empty legend dive to the map 
    legendControl.addTo(map);

    // select the legend, add a title, begin an unordered list and assign to variable 
    const legend = $('#legend').html(`<h5>${attributeValue}</h5>`);

    // loop through the array of classification break values
    for (let i = 0; i <= breaks.length - 1; i++) {

      let color = getColor(breaks[i][0], breaks);

      legend.append(
        `<span style="background:${color}"></span>
      <label>${(breaks[i][0]*100).toLocaleString()} &mdash;
        ${(breaks[i][1]*100).toLocaleString()}%</label>`);
    }
  }
  ///////////////////////////////////////////////////////////////////////
  function addUi(blockGroups) {
    // create the slider control 
    var selectControl = L.control({
      position: 'topright'
    });

    // when control is added 
    selectControl.onAdd = function () {
      // get the element with id attribute of ui-controls 
      return L.DomUtil.get("dropdown-ui");
    };
    // add control to the map 
    selectControl.addTo(map)

    $('#dropdown-ui select').change(function () {
      attributeValue = this.value;

      console.log(this.value)
      updateMap(blockGroups)
    })
  }
  //////////////////////////////////////////////////////////////////////
</script>

</html>